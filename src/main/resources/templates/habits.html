<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>習慣リスト</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="d-flex justify-content-center align-items-start py-5 bg-light">
    <div class="container" style="max-width: 600px;">
        <h2 class="mb-4 text-center" th:text="${username} + ' さんの習慣'"></h2>

        <!-- 習慣追加フォーム -->
        <form th:action="@{/habit}" method="post" class="row g-2 mb-4">
            <div class="col-8">
                <input type="text" name="name" class="form-control" placeholder="新しい習慣" required>
            </div>
            <div class="col-4">
                <button type="submit" class="btn btn-primary w-100">追加</button>
            </div>
        </form>

        <!-- 習慣リスト -->
        <ul class="list-group mb-4">
            <li th:each="habit : ${habits}" class="list-group-item d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <span th:text="${habit.name}" class="fw-bold"></span>
                </div>
                
                <div class="d-flex justify-content-end align-items-center gap-2" style="min-width: 250px;">
                    <form th:action="@{/record}" method="post" class="d-inline">
                        <input type="hidden" name="habitId" th:value="${habit.id}">
                        <input type="hidden" name="completed" value="true">
                        <button type="submit" class="btn btn-success btn-sm">今日達成！</button>
                    </form>

                    <a th:href="@{/records/{id}(id=${habit.id})}" class="btn btn-outline-secondary btn-sm">履歴</a>

                    <form th:action="@{/habit/delete/{id}(id=${habit.id})}" method="post" class="d-inline"
                            onsubmit="return confirm('本当に削除しますか？');">

                        <!-- CSRF トークン -->
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        
                        <button type="submit" class="btn btn-danger btn-sm">削除</button>
                    </form>
                </div>
            </li>
        </ul>

        <a th:href="@{/logout}" class="btn btn-link">ログアウト</a>
    </div>

    
    <div style="max-width: 600px; height: 400px; margin: auto; margin-left: 5%;">
        <h2 class="text-xl font-semibold mb-2 text-center">習慣ごとの達成率</h2>
        <canvas id="habitChart" style="width: 130%; height: 100%;"></canvas>
    </div>

    <script th:inline="javascript">

        // const habits = /*[[${habits}]]*/ [];
        // const achievementRates = /*[[${achievementRates}]]*/ {};
        /*<![CDATA[*/
        document.addEventListener("DOMContentLoaded", function() {
            const habitStats = /*[[${habitStats}]]*/ [];
            console.log("habitStats:", habitStats);//デバック用

            if(!habitStats || habitStats.length === 0) {
                console.log("表示する習慣データがありません。");
                return;
            }

            const labels = habitStats.map(h => h.name);
            const data = habitStats.map(h => h.rate);

            const ctx = document.getElementById('habitChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '達成率(%)',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', //横棒
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100
                        },
                        y: {
                            //縦グラフ用
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false, text: '習慣ごとの達成率' }
                    }
                }
            });
        });
        /*]]>*/
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>